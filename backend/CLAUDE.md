# Backend Module - FastAPI Voice Cloning API

[Root Directory](../CLAUDE.md) > **backend**

> Last Updated: 2026-02-06 09:27:24 | Generated by init-architect

## Changelog

### 2026-02-06 09:27:24 - Initial Documentation
- Module structure and architecture documented
- API endpoints and schemas catalogued
- Integration patterns with GPT-SoVITS detailed
- Security and configuration patterns documented

---

## Module Responsibility

The backend module is a **FastAPI REST API** that serves as a secure proxy between the frontend application and the GPT-SoVITS voice cloning service. It provides:

- **API Gateway**: RESTful endpoints for voice synthesis operations
- **Authentication**: API key-based security layer
- **Request Validation**: Pydantic schemas for input/output validation
- **Service Integration**: Async HTTP client for GPT-SoVITS communication
- **Error Handling**: Structured exception handling and logging
- **Health Monitoring**: Service availability checks

---

## Entry Points and Startup

### Main Application Entry
**File**: `app/main.py`

**Startup Sequence**:
1. Load configuration from environment variables (`.env`)
2. Initialize FastAPI application with OpenAPI documentation
3. Configure CORS middleware for frontend origins
4. Register request logging middleware
5. Register global exception handlers
6. Include API routers (voice routes)
7. Start uvicorn ASGI server

**Run Commands**:
```bash
# Development (auto-reload)
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# Direct execution
python -m app.main

# Production (with workers)
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

**Lifespan Events**:
- **Startup**: Log application name, version, and GPT-SoVITS URL
- **Shutdown**: Log graceful shutdown message

---

## Public API Endpoints

### Health Check
```
GET /health
Response: HealthResponse (JSON)
```
**Purpose**: Check API and GPT-SoVITS service health
**Authentication**: None (public endpoint)
**Response Fields**:
- `status`: "healthy" | "degraded" | "unhealthy"
- `version`: API version string
- `sovits_available`: boolean
- `uptime_seconds`: float

### Voice Synthesis
```
POST /api/v1/voice/synthesize
Content-Type: multipart/form-data
Headers: X-API-Key: <api-key>
Response: Binary audio data (WAV)
```
**Purpose**: Synthesize speech from text using reference voice
**Authentication**: Required (API key)
**Request Parameters**:
- `text` (required): Text to synthesize (1-5000 chars)
- `reference_audio` (required): Audio file (WAV/MP3/FLAC/OGG, max 10MB)
- `language` (optional): "auto" | "zh" | "en" | "ja" (default: "auto")
- `speed` (optional): 0.5-2.0 (default: 1.0)
- `temperature` (optional): 0.1-1.0 (default: 0.7)

**Response Headers**:
- `Content-Type`: audio/wav
- `Content-Disposition`: attachment; filename="synthesized.wav"
- `X-Audio-Duration`: Approximate duration in seconds

**Error Responses**:
- `401 Unauthorized`: Missing or invalid API key
- `400 Bad Request`: Invalid input (empty text, wrong file type, file too large)
- `504 Gateway Timeout`: GPT-SoVITS service timeout
- `502 Bad Gateway`: GPT-SoVITS service error
- `500 Internal Server Error`: Unexpected error

### Voice Service Health
```
GET /api/v1/voice/health
Headers: X-API-Key: <api-key>
Response: JSON
```
**Purpose**: Check GPT-SoVITS service availability
**Authentication**: Required (API key)

---

## Key Dependencies and Configuration

### Python Dependencies
**File**: `requirements.txt`

**Core Framework**:
- `fastapi==0.109.0` - Web framework
- `uvicorn[standard]==0.27.0` - ASGI server
- `python-multipart==0.0.6` - File upload support

**Validation & Settings**:
- `pydantic==2.5.3` - Data validation
- `pydantic-settings==2.1.0` - Settings management
- `python-dotenv==1.0.0` - Environment variables

**HTTP Client**:
- `httpx==0.26.0` - Async HTTP client for GPT-SoVITS

**Development Tools**:
- `pytest==7.4.4` - Testing framework
- `pytest-asyncio==0.23.3` - Async test support
- `black==24.1.1` - Code formatter
- `flake8==7.0.0` - Linter
- `mypy==1.8.0` - Type checker

### Configuration System
**File**: `app/core/config.py`

**Settings Class**: `Settings` (Pydantic BaseSettings)

**Environment Variables** (`.env` file):
```bash
# Application
APP_NAME="Voice Cloning API"
APP_VERSION="1.0.0"
DEBUG=false

# API Configuration
API_V1_PREFIX="/api/v1"
API_KEY="<generated-secure-key>"

# CORS
CORS_ORIGINS="http://localhost:3000,http://localhost:5173"

# GPT-SoVITS Configuration
SOVITS_BASE_URL="http://localhost:9880"
SOVITS_TIMEOUT=300

# File Upload
MAX_UPLOAD_SIZE=10485760  # 10MB in bytes
ALLOWED_AUDIO_FORMATS="wav,mp3,flac,ogg"

# Logging
LOG_LEVEL="INFO"
```

**Configuration Access**:
```python
from app.core.config import settings
print(settings.SOVITS_BASE_URL)
```

---

## Data Models and Schemas

### Pydantic Schemas
**File**: `app/models/schemas.py`

**LanguageEnum**:
```python
class LanguageEnum(str, Enum):
    CHINESE = "zh"
    ENGLISH = "en"
    JAPANESE = "ja"
    AUTO = "auto"
```

**SynthesizeRequest**:
- `text`: str (1-5000 chars, required)
- `reference_audio_url`: Optional[str]
- `language`: LanguageEnum (default: AUTO)
- `speed`: float (0.5-2.0, default: 1.0)
- `temperature`: float (0.1-1.0, default: 0.7)

**SynthesizeResponse**:
- `success`: bool
- `audio_url`: Optional[str]
- `audio_format`: Optional[str]
- `duration_seconds`: Optional[float]
- `message`: Optional[str]

**ErrorResponse**:
- `success`: bool (always False)
- `error`: str (error type/code)
- `message`: str (human-readable)
- `details`: Optional[dict]

**HealthResponse**:
- `status`: str ("healthy" | "degraded" | "unhealthy")
- `version`: str
- `sovits_available`: bool
- `uptime_seconds`: float

---

## Service Layer

### GPT-SoVITS Client
**File**: `app/services/sovits_client.py`

**Class**: `SoVITSClient`

**Methods**:

1. **`health_check() -> bool`**
   - Checks if GPT-SoVITS service is reachable
   - Timeout: 5 seconds
   - Returns: True if healthy, False otherwise

2. **`synthesize(...) -> bytes`**
   - Sends synthesis request to GPT-SoVITS
   - Parameters: text, reference_audio, language, speed, temperature
   - Timeout: 300 seconds (configurable)
   - Returns: Audio data as bytes (WAV format)
   - Raises: httpx.HTTPError, ValueError

**Integration Pattern**:
```python
from app.services.sovits_client import sovits_client

# Health check
is_healthy = await sovits_client.health_check()

# Synthesize
audio_data = await sovits_client.synthesize(
    text="Hello world",
    reference_audio=file_object,
    language="en",
    speed=1.0,
    temperature=0.7
)
```

**Request Format to GPT-SoVITS**:
- Method: POST
- Endpoint: `/synthesize`
- Content-Type: multipart/form-data
- Fields:
  - `reference_audio`: Binary file data
  - `text`: String
  - `language`: String
  - `speed`: Float
  - `temperature`: Float

---

## Security Layer

### Authentication
**File**: `app/core/security.py`

**Mechanism**: API Key Header Authentication

**Header Name**: `X-API-Key`

**Implementation**:
```python
from fastapi import Depends
from app.core.security import verify_api_key

@router.post("/protected-endpoint")
async def protected_route(api_key: str = Depends(verify_api_key)):
    # api_key is validated here
    pass
```

**Validation Logic**:
1. Extract `X-API-Key` header from request
2. Compare with `settings.API_KEY`
3. Raise 401 Unauthorized if missing or invalid
4. Return validated key if successful

**Security Considerations**:
- Single shared API key (basic security model)
- Key stored in environment variable (never in code)
- HTTPS recommended for production (use reverse proxy)
- Consider rate limiting for production deployments

---

## Testing and Quality

### Test Framework
**Framework**: pytest + pytest-asyncio
**Configuration**: `pytest.ini` (if exists) or inline in `pyproject.toml`

**Test Structure** (recommended):
```
backend/
├── tests/
│   ├── __init__.py
│   ├── conftest.py          # Fixtures
│   ├── test_api/
│   │   ├── test_voice.py    # Voice endpoint tests
│   │   └── test_health.py   # Health endpoint tests
│   ├── test_services/
│   │   └── test_sovits_client.py
│   └── test_core/
│       ├── test_config.py
│       └── test_security.py
```

**Running Tests**:
```bash
pytest                    # Run all tests
pytest -v                 # Verbose output
pytest -k "test_health"   # Run specific tests
pytest --cov=app          # With coverage report
```

### Code Quality Tools

**Black** (Code Formatter):
```bash
black app/                # Format all code
black --check app/        # Check without modifying
```

**Flake8** (Linter):
```bash
flake8 app/               # Lint all code
flake8 --max-line-length=100 app/
```

**Mypy** (Type Checker):
```bash
mypy app/                 # Type check all code
mypy --strict app/        # Strict mode
```

---

## Common Issues and FAQ

### Q: Backend won't start - ModuleNotFoundError
**A**: Ensure conda environment is activated:
```bash
conda activate voice_api
```

### Q: Can't connect to GPT-SoVITS
**A**: Verify GPT-SoVITS is running:
```bash
curl http://localhost:9880/health
```
Check `SOVITS_BASE_URL` in `.env` file.

### Q: CORS errors in browser
**A**: Add frontend URL to `CORS_ORIGINS` in `.env`:
```bash
CORS_ORIGINS="http://localhost:3000,http://localhost:5173"
```
Restart backend after changing `.env`.

### Q: File upload fails with "File too large"
**A**: Check `MAX_UPLOAD_SIZE` in `.env` (default 10MB):
```bash
MAX_UPLOAD_SIZE=52428800  # 50MB
```

### Q: Synthesis times out
**A**: Increase `SOVITS_TIMEOUT` in `.env`:
```bash
SOVITS_TIMEOUT=600  # 10 minutes
```

### Q: How to generate a secure API key?
**A**: Use Python's secrets module:
```bash
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

---

## Related Files

### Core Application Files
- `app/main.py` - Application entry point and configuration
- `app/core/config.py` - Settings and environment variables
- `app/core/security.py` - Authentication logic

### API Layer
- `app/api/__init__.py` - API package initialization
- `app/api/routes/__init__.py` - Routes package
- `app/api/routes/voice.py` - Voice synthesis endpoints

### Service Layer
- `app/services/__init__.py` - Services package
- `app/services/sovits_client.py` - GPT-SoVITS HTTP client

### Data Models
- `app/models/__init__.py` - Models package
- `app/models/schemas.py` - Pydantic request/response schemas

### Configuration
- `requirements.txt` - Python dependencies
- `.env.example` - Environment variable template
- `.env` - Actual environment variables (not in git)

### Documentation
- `README.md` - Backend-specific documentation
- `CLAUDE.md` - This file

---

## Development Workflow

### Adding a New Endpoint

1. **Define Schema** in `app/models/schemas.py`:
```python
class NewRequest(BaseModel):
    field: str = Field(..., description="Description")
```

2. **Create Route** in `app/api/routes/`:
```python
@router.post("/new-endpoint")
async def new_endpoint(
    request: NewRequest,
    api_key: str = Depends(verify_api_key)
):
    # Implementation
    pass
```

3. **Test** with Swagger UI at `/docs`

4. **Write Tests** in `tests/test_api/`

### Modifying GPT-SoVITS Integration

1. **Update Client** in `app/services/sovits_client.py`
2. **Update Schemas** if request/response format changes
3. **Update Route Handlers** to use new client methods
4. **Test Integration** with actual GPT-SoVITS service

### Debugging Tips

1. **Check Logs**: Backend logs all requests and responses
2. **Use Swagger UI**: Interactive API testing at `/docs`
3. **Test with curl**: Isolate frontend vs backend issues
4. **Check GPT-SoVITS**: Verify external service is healthy
5. **Validate Input**: Use Pydantic validation errors for debugging

---

## Performance Considerations

- **Async I/O**: All I/O operations use async/await
- **Connection Pooling**: httpx client reuses connections
- **Timeout Management**: Configurable timeouts prevent hanging
- **File Streaming**: Consider implementing for large files
- **Concurrent Requests**: Limited by GPT-SoVITS capacity
- **Memory Usage**: Audio data held in memory (consider streaming)

---

## Future Enhancements

1. **Rate Limiting**: Add per-key rate limits
2. **Caching**: Cache synthesis results for repeated requests
3. **Queue System**: Implement job queue for high load
4. **Monitoring**: Add Prometheus metrics
5. **User Management**: Multi-user authentication
6. **Batch Processing**: Support multiple texts in one request
7. **Streaming**: Stream audio as it's generated
8. **Database**: Store synthesis history and user data
